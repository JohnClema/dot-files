# To use this prompt, add the following to your bash config file.
#
#     source ~/.bash_prompt
#
# Your bash config file is ~/.bash_profile.

# Colour attribute codes

ATTR_NORMAL=0
ATTR_BRIGHT=1
# Dim Text: 2
# Underlined Text: 4
# Blinking Text: 5 (This does not work in most terminal emulators.)
# Reversed Text: 7 (This inverts the foreground and background colors, so youâ€™ll see black text on a white background if the current text is white text on a black background.)
# Hidden Text: 8

FG_BLACK=30
FG_RED=31
FG_GREEN=32
FG_YELLOW=33
FG_BLUE=34
FG_VIOLET=35
FG_CYAN=36
FG_WHITE=37

FG_NULL=00

BG_BLACK=40
BG_RED=41
BG_GREEN=42
BG_YELLOW=43
BG_BLUE=44
BG_VIOLET=45
BG_CYAN=46
BG_WHITE=47

BG_NULL=00

# ANSI escape sequences

ESC="\033"
NORMAL="\[$ESC[m\]"
RESET="\[$ESC[${ATTR_NORMAL};${FG_NULL};${BG_NULL}m\]"

GREEN="\[$ESC[${ATTR_NORMAL};${FG_GREEN}m\]"
BLUE="\[$ESC[${ATTR_NORMAL};${FG_BLUE}m\]"
VIOLET="\[$ESC[${ATTR_NORMAL};${FG_VIOLET}m\]"
RED="\[$ESC[${ATTR_NORMAL};${FG_RED}m\]"

# Functions

# Timing (from Gary Bernhart, https://github.com/garybernhardt/dotfiles)
function minutes_since_last_commit {
    now=$(date +%s)
    last_commit=$(git log --pretty=format:'%at' -1)
    seconds_since_last_commit=$((now-last_commit))
    minutes_since_last_commit=$((seconds_since_last_commit/60))
    echo $minutes_since_last_commit
}

git_since_last_commit() {
    local MINUTES_SINCE_LAST_COMMIT=$(minutes_since_last_commit)

    if [ "$MINUTES_SINCE_LAST_COMMIT" -gt 30 ]; then
	local COLOR=${RED}
    elif [ "$MINUTES_SINCE_LAST_COMMIT" -gt 10 ]; then
	local COLOR=${YELLOW}
    else
	local COLOR=${GREEN}
    fi

    echo "${COLOR}$(minutes_since_last_commit)m"
}

join_by() { local IFS="$1"; shift; echo "$*"; }

git_current_branch() {
    git branch 2> /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/\1/'
}

git_info() {
    BRANCH="$(git_current_branch)"
    if [ -n "$BRANCH" ]; then
        echo "${GREEN}(${BRANCH}|$(git_since_last_commit)${GREEN})"
    fi
}

# Prompt

export PS1="${VIOLET}\d \A ${BLUE}\u${NORMAL}@${BLUE}\h${NORMAL} \W $(git_info)\n${RESET}\\$ "
